<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syn√§sthesie - Modul Test v3</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <button id="fullscreenToggle" style="display:none;">‚õ∂</button>
    <div id="streamStatus"></div>
    <div id="vignetteOverlay"></div>
    
    <div id="ui" style="display:none;">
        <select id="modelSetSelect"></select>
        <button id="scanModelSetsBtn">üîÑ</button>
        <div id="modelSetStatus"></div>
    </div>
    
    <canvas id="canvas"></canvas>
    <canvas id="aiOverlayCanvas"></canvas>

    <div id="testStatus" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); 
        background:rgba(0,0,0,0.95); padding:20px 30px; border-radius:12px; color:#fff; 
        font-family:'SF Mono',Monaco,monospace; z-index:1000; min-width:500px; max-height:85vh; overflow-y:auto;
        border: 1px solid #333;">
        <h2 style="color:#4f4; margin-bottom:15px; font-size:18px;">üß™ Syn√§sthesie Modul-Test v3</h2>
        <div id="testLog" style="font-size:11px; line-height:1.6;"></div>
        <div id="testSummary" style="margin-top:15px; padding-top:15px; border-top:1px solid #333;"></div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        let passed = 0, failed = 0;
        
        const log = (msg, success = true) => {
            const div = document.getElementById('testLog');
            const color = success ? '#4f4' : '#f44';
            div.innerHTML += `<div style="color:${color}; margin:2px 0;">${success ? '‚úì' : '‚úó'} ${msg}</div>`;
            if (success) passed++; else failed++;
        };

        const logSection = (title) => {
            const div = document.getElementById('testLog');
            div.innerHTML += `<div style="color:#888; margin:12px 0 6px 0; font-weight:bold; text-transform:uppercase; font-size:10px; letter-spacing:1px;">${title}</div>`;
        };

        const logError = (msg, err) => {
            log(`${msg}: ${err.message}`, false);
            console.error(err);
        };

        async function runTests() {
            log('Starte Tests f√ºr 18 Module...');
            
            // ========== CONFIG ==========
            logSection('Config (2 Module)');
            
            try {
                const colors = await import('./js/config/colors.js');
                log('colors.js');
                if (colors.ClaraColors?.notes?.C) log('  ClaraColors ‚úì');
                if (colors.AlexColors?.modes) log('  AlexColors ‚úì');
            } catch (err) { logError('colors.js', err); }

            try {
                const intervals = await import('./js/config/intervals.js');
                log('intervals.js');
                if (intervals.IntervalNames?.[12]?.name === 'Oktave') log('  IntervalNames ‚úì');
            } catch (err) { logError('intervals.js', err); }

            // ========== CORE ==========
            logSection('Core (3 Module)');
            
            try {
                const setup = await import('./js/core/three-setup.js');
                log('three-setup.js');
                if (setup.scene && setup.camera && setup.renderer) log('  Scene/Camera/Renderer ‚úì');
                if (setup.composer) log('  EffectComposer ‚úì');
            } catch (err) { logError('three-setup.js', err); }

            try {
                const postproc = await import('./js/core/postprocessing.js');
                log('postprocessing.js');
                if (postproc.edgePass && postproc.blurPasses?.length === 8) log('  EdgePass + 8 BlurPasses ‚úì');
            } catch (err) { logError('postprocessing.js', err); }

            try {
                const particles = await import('./js/core/particles.js');
                log('particles.js');
                const ps = particles.initParticleSystem();
                if (ps) log('  ParticleSystem ‚úì');
            } catch (err) { logError('particles.js', err); }

            // ========== MODELS ==========
            logSection('Models (1 Modul)');
            
            try {
                const models = await import('./js/models/model-manager.js');
                log('model-manager.js');
                await models.initializeModels();
                if (models.modelState.currentModel) log('  Model geladen ‚úì');
                if (models.modelState.availableModelSets.length > 0) 
                    log(`  ${models.modelState.availableModelSets.length} Sets ‚úì`);
            } catch (err) { logError('model-manager.js', err); }

            // ========== EFFECTS ==========
            logSection('Effects (1 Modul)');
            
            try {
                const effects = await import('./js/effects/visual-effects.js');
                log('visual-effects.js');
                if (effects.activeEffects instanceof Set) log('  activeEffects ‚úì');
                if (effects.toggleEffect && effects.applyEffects) log('  Functions ‚úì');
            } catch (err) { logError('visual-effects.js', err); }

            // ========== AUDIO ==========
            logSection('Audio (4 Module)');
            
            try {
                const audio = await import('./js/audio/audio-chain.js');
                log('audio-chain.js');
                if (audio.createAudioChain && audio.setEqGain) log('  Functions ‚úì');
            } catch (err) { logError('audio-chain.js', err); }

            try {
                const beat = await import('./js/audio/beat-detector.js');
                log('beat-detector.js');
                if (beat.detectBeat && beat.beatState) log('  detectBeat + state ‚úì');
            } catch (err) { logError('beat-detector.js', err); }

            try {
                const pitch = await import('./js/audio/pitch-detector.js');
                log('pitch-detector.js');
                if (pitch.PitchDetector && pitch.activeAlgorithms) log('  PitchDetector Class ‚úì');
            } catch (err) { logError('pitch-detector.js', err); }

            try {
                const perc = await import('./js/audio/percussion.js');
                log('percussion.js');
                if (perc.PercussionDetector && perc.percussionState) log('  PercussionDetector Class ‚úì');
            } catch (err) { logError('percussion.js', err); }

            // ========== INPUT ==========
            logSection('Input (2 Module)');
            
            try {
                const midi = await import('./js/input/midi.js');
                log('midi.js');
                if (midi.loadMidiDevices && midi.midiToNoteObject) log('  MIDI Functions ‚úì');
            } catch (err) { logError('midi.js', err); }

            try {
                const speech = await import('./js/input/speech.js');
                log('speech.js');
                if (speech.filterTextByWordType && speech.initSpeechRecognition) log('  Speech Functions ‚úì');
            } catch (err) { logError('speech.js', err); }

            // ========== ANALYSIS ==========
            logSection('Analysis (2 Module)');
            
            try {
                const intAnalysis = await import('./js/analysis/intervals.js');
                log('intervals.js (analysis)');
                if (intAnalysis.analyzeIntervals && intAnalysis.detectChord) log('  Interval Analysis ‚úì');
                
                // Test: Analysiere C-Dur
                const cMajor = [
                    { name: 'C', midi: 60 },
                    { name: 'E', midi: 64 },
                    { name: 'G', midi: 67 }
                ];
                const result = intAnalysis.analyzeIntervals(cMajor);
                if (result?.chord?.type === 'major') log('  C-Dur erkannt ‚úì');
            } catch (err) { logError('intervals.js (analysis)', err); }

            try {
                const colorCalc = await import('./js/analysis/colors.js');
                log('colors.js (analysis)');
                if (colorCalc.getColorForNote && colorCalc.applyColors) log('  Color Functions ‚úì');
            } catch (err) { logError('colors.js (analysis)', err); }

            // ========== CAMERA ==========
            logSection('Camera (1 Modul)');
            
            try {
                const camera = await import('./js/camera/controls.js');
                log('controls.js');
                if (camera.resetCamera && camera.toggleAutoOrbit) log('  Camera Controls ‚úì');
            } catch (err) { logError('controls.js', err); }

            // ========== STREAM ==========
            logSection('Stream (1 Modul)');
            
            try {
                const stream = await import('./js/stream/obs-stream.js');
                log('obs-stream.js');
                if (stream.startStreamCapture && stream.getStreamDimensions) {
                    const dims = stream.getStreamDimensions();
                    log(`  Stream ${dims.width}x${dims.height} ‚úì`);
                }
            } catch (err) { logError('obs-stream.js', err); }

            // ========== RENDER TEST ==========
            logSection('Integration');
            
            try {
                const { composer, controls } = await import('./js/core/three-setup.js');
                let frames = 0;
                const start = performance.now();
                
                function animate() {
                    if (frames < 60) {
                        requestAnimationFrame(animate);
                        controls.update();
                        composer.render();
                        frames++;
                    } else {
                        const elapsed = performance.now() - start;
                        const fps = Math.round(60 / (elapsed / 1000));
                        log(`Render: 60 Frames @ ~${fps} FPS`);
                        showSummary();
                    }
                }
                animate();
            } catch (err) { 
                logError('Render', err);
                showSummary();
            }
        }

        function showSummary() {
            const summary = document.getElementById('testSummary');
            const total = passed + failed;
            const percent = Math.round((passed / total) * 100);
            const color = failed === 0 ? '#4f4' : (failed < 3 ? '#ff0' : '#f44');
            
            summary.innerHTML = `
                <div style="font-size:14px; color:${color}; font-weight:bold;">
                    ${failed === 0 ? 'üéâ ALLE TESTS BESTANDEN!' : `‚ö†Ô∏è ${failed} FEHLER`}
                </div>
                <div style="font-size:12px; color:#888; margin-top:8px;">
                    ${passed}/${total} Tests (${percent}%) | 18 Module
                </div>
                <div style="font-size:11px; color:#666; margin-top:10px;">
                    Config: 2 | Core: 3 | Models: 1 | Effects: 1<br>
                    Audio: 4 | Input: 2 | Analysis: 2 | Camera: 1 | Stream: 1
                </div>
            `;
            
            setTimeout(() => {
                document.getElementById('testStatus').style.opacity = '0.3';
            }, 5000);
        }

        runTests();
    </script>
</body>
</html>
